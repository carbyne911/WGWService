@Library('devops-jenkins-lib') _
def appVersion = ''
gitCredentialsId = 'e4729b13-caae-4669-972f-5307ae6309f4'
awsCredentialsId = 'dab6216e-af1e-45e8-b957-58796cc47fa2'
prodCredentialsId = 'aws-credentials-production'
GovproddockerCredentialsId = 'aws-credentials-production-govcloud'

appGitUrl = 'hhttps://github.com/carbyne911/WGWService.git'
imageName = 'wgw_service'

pipeline {
    options {
        timestamps()
        disableConcurrentBuilds()
		skipDefaultCheckout()
        timeout(time: 3, unit: 'HOURS')
    }
    agent {
        kubernetes {
            cloud 'jenkins'
            yamlFile 'ci/pod.yaml'
        }
    }
//    triggers {
//        pollSCM('H/30 * * * *') // every 30 mins
//    }
    parameters {
        gitParameter branchFilter: 'origin/(.*)', defaultValue: 'master', name: 'GIT_BRANCH', type: 'PT_BRANCH'
        string(name: 'Stack', defaultValue: 'stage', description: 'Name of the Stack')
    }
    environment {
        AWS_DEFAULT_REGION = 'eu-central-1'
        SERVICE_NAME = 'WGWService'
        STACK = 'dev'
        CODE_DEPLOY_STACK = 'Staging'
    }
    stages {
	    stage ('Checkout Code') {
            steps {
            echo 'checkout Code'
            checkout([$class: 'GitSCM', branches: [[name: '*/$GIT_BRANCH']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'CloneOption', noTags: false, reference: '', shallow: false, timeout: 10], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'e4729b13-caae-4669-972f-5307ae6309f4', url: 'https://github.com/carbyne911/WGWService.git']]])
            }    
        }
        stage('Parsing WGW Build Version') {
            steps {
                script {
                    def file = "${WORKSPACE}/ci/deployment/scripts/deploy-scripts/wgw_version"
                    appVersion = readFile(file)
                    println(appVersion)

                }
            }
        }
        stage('Deploy image to ECR') {
            steps {
                script {
                    utils.buildDockerImageRealTimeStage(
                            ecrRepo: '366789379256.dkr.ecr.eu-west-1.amazonaws.com',
			    ecrRepoProd: '924197678267.dkr.ecr.eu-west-1.amazonaws.com',
			    ecrRepoProdGov: '711704522513.dkr.ecr.us-gov-west-1.amazonaws.com',
                            gitBranch:"${GIT_BRANCH}",
                            imageName:"${imageName}_stage",
			    imageNameProd:"${imageName}",
			    imageNameProdGov:"${imageName}_gov",
			    imageNameVersionProd:"${imageName}:${appVersion}",
			    imageNameVersionProdGOV:"${imageName}_gov:${appVersion}",
                            imageNameVer: "${imageName}_stage:${appVersion}",
                            imageNameLatest: "${imageName}_stage:latest",
                            dockerCredentialsId: 'ecr:eu-west-1:dab6216e-af1e-45e8-b957-58796cc47fa2',
                            proddockerCredentialsId: 'ecr:eu-west-1:aws-credentials-production',
			    GovproddockerCredentialsId: 'ecr:us-gov-west-1:aws-credentials-production-govcloud',

                    )
                }
            }
        }
        stage('AWS-CodeDeploy-Ireland') {
            steps {
                script {
                    utils.awsCodeDeployWGW(
                            credentialsId: awsCredentialsId,
                    )
               }
            }
        }
        
    }
    post {
        always {
            script {
                manager.addShortText(manager.build.causes.collect { it.shortDescription }.unique(false).join("\n"))
                manager.addShortText(params.GIT_BRANCH)
            }
        }
        unsuccessful {
            step([$class                  : 'Mailer',
                  notifyEveryUnstableBuild: true,
                  recipients              : 'team04@carbyne911.com',
                  sendToIndividuals       : true
            ])
        }
        fixed {
            step([$class                  : 'Mailer',
                  notifyEveryUnstableBuild: true,
                  recipients              : 'team04@carbyne911.com',
                  sendToIndividuals       : true
            ])
        }
    }
}
