@Library('devops-jenkins-lib') _
stageCredentialsId = 'dab6216e-af1e-45e8-b957-58796cc47fa2'
prodCredentialsId = 'aws-credentials-production'
codeDeployS3Bucket = 'carbyne-wgw-service-releases-prod'
imageName = 'wgw_service'


pipeline {
    options {
        timestamps()
        disableConcurrentBuilds()
        skipDefaultCheckout()
        timeout(time: 2, unit: 'HOURS')
    }
    agent {
        kubernetes {
            cloud 'jenkins'
            yamlFile 'ci/pod.yaml'
        }
    }
    parameters {
        string(name: 'WGW_VERSION', defaultValue: 'X.Y.Z', description: 'Put app version here. Must fill manually.')
    }
    environment {
        AWS_DEFAULT_REGION = 'eu-central-1'
        SERVICE_NAME = 'WGWService'
        STACK = 'prod'
        CODE_DEPLOY_STACK = 'PreProduction'
        WGW_VERSION = '${WGW_VERSION}'
    }
    stages {
	stage ('Checkout Code') {
            steps {
            echo 'checkout Code'
            checkout([$class: 'GitSCM', branches: [[name: '*/feature/REP-48994']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'CloneOption', noTags: false, reference: '', shallow: false, timeout: 10], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'e4729b13-caae-4669-972f-5307ae6309f4', url: 'https://github.com/carbyne911/WGWService.git']]])
            }    
        }
    stage('AWS-CodeDeploy-Production-EU-CENTRAL-1') {
            steps {
                script {
                    utils.awsCodeDeployProdRealTime(
                            credentialsId: prodCredentialsId,
                            credentialsIdStage: stageCredentialsId,
                            codeDeployS3Bucket: codeDeployS3Bucket,
                    )
                }
            }
        }
    }
   post {
        unsuccessful {
            step([$class                  : 'Mailer',
                  notifyEveryUnstableBuild: true,
                  recipients              : 'team04@carbyne911.com',
                  sendToIndividuals       : true
            ])
        }
        fixed {
            step([$class                  : 'Mailer',
                  notifyEveryUnstableBuild: true,
                  recipients              : 'team04@carbyne911.com',
                  sendToIndividuals       : true
            ])
        }
}
}
